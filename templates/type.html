{% extends "base.html" %}

{% macro list_item(thing) -%}
  {% set node = get_node(thing) %}
  {%- if not get_node(node.type).suppress_page_generation -%}
    <p>
      <b>{{- link(thing) -}}</b>
      {% if count(related('implementation_of', key=thing)) %}
        (in
        {% for implementation in related('implementation_of', key=thing) -%}
          {{ link(get_node(implementation).host_language) -}}
          {%- if not loop.last %} and {% endif -%}
        {%- endfor -%}
        )
      {% endif %}
      {%- if node.inception_date %}
        ({{ node.inception_date }})
      {% endif %}
    </p>
  {%- else -%}
    {{- thing -}}
  {%- endif -%}

  {% if online_buttons(thing) %}
  <p>
    {{ online_buttons(thing) }}
  </p>
  {% endif %}

  {% if node.images %}
    <div class="row-fluid">
      <div class="span8">
        {% if node.description %}
          {{ md2html(node.description) }}
        {% endif %}
      </div>
      <div class="span4">
        {% for image in node.images %}
          <img src="{{ image.url }}">
        {% endfor %}
      </div>
    </div>
  {% elif node.description %}
    {{ md2html(node.description) }}
  {% endif %}
{%- endmacro %}

{% block title %}{{ plural(key) }} | Cat's Eye Technologies{% endblock title %}

{% block heading %}
  <h1>{{ plural(key) }}</h1>
{% endblock %}

{% set collected_auspices = group_by(related_items('type'), 'auspices') %}

{% block description_verbiage %}
  {%- if description -%}
    {{- md2html(description) -}}
  {%- elif collected_auspices.keys() == [None] %}
    <p>
      This is a list of {{ plural(key)|lower }} with entries in {{ link('Chrysoberyl') }}.
    </p>
  {%- endif -%}
{% endblock description_verbiage %}

{# note: some types will not use the 'index' block for this; they will instead
   put their index into the 'content' block, if they want to appear below
   any images and/or exploit maximum horizontal real estate. #}

{% block index %}
  {% for auspices, things in iteritems_sorted_within(
      collected_auspices, [
          "Cat's Eye Technologies",
          "What is this I don't even",
          "None",
      ]
  ) %}
    {% if collected_auspices.keys() != [None] %}
      <h3>by {% if auspices == None %}Our Valued Partners{% else %}{{ auspices }}{% endif %}</h3>
    {% endif %}
    <ul>
      {%- for thing in keys_sorted_within(things, ordered_within) -%}
        {% if is_current(get_node(thing)) and online_buttons(thing)
              and not (auspices == None and
                       has_implementation_by_one_of(thing, [
                           "Cat's Eye Technologies",
                           "What is this I don't even",
                       ])) %}
          <li>{{ list_item(thing) }}</li>
        {% endif %}
      {%- endfor -%}
      {%- for thing in keys_sorted_within(things, ordered_within) -%}
        {% if is_current(get_node(thing)) and not online_buttons(thing)
              and not (auspices == None and
                       has_implementation_by_one_of(thing, [
                           "Cat's Eye Technologies",
                           "What is this I don't even",
                       ])) %}
          <li>{{ list_item(thing) }}</li>
        {% endif %}
      {%- endfor -%}
    </ul>
    {%- set impl_count = count(filter_items(implementations_by_p(key, auspices))) -%}
    {%- if impl_count > 0 -%}
      <h4>implemented by {{ auspices }}</h4>
      <ul>
        {%- for (implkey, node) in filter_items(implementations_by_p(key, auspices))|sort -%}
          {% set ckey = node.implementation_of[0] %}
          <li>
            <p>
              {{ link(ckey) }} â€” as {{ link(implkey) }}
              {% if node.host_language %}
                in {{ link(node.host_language) }}
              {% endif %}
              {% if node.host_platform %}
                for {{ link(node.host_platform) }}
              {% endif %}
              {% if node.inception_date %}
                ({{ node.inception_date }})
              {% endif %}
            </p>
            {% if get_node(ckey).description %}
              {{ md2html(get_node(ckey).description) }}
            {% endif %}
            {% if node.description %}
              {{ md2html(node.description) }}
            {% endif %}
            {#
            {% if node.commentary %}
              {{ md2html(node.commentary) }}
            {% endif %}
            #}
          </li>
        {%- endfor -%}
      </ul>
    {%- endif -%}
  {%- endfor -%}
{% endblock index %}
