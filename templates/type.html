{% extends "base.html" %}

{% macro list_item(thing) -%}
  {% set node = get_node(thing) %}
  {%- if not get_node(node.type).suppress_page_generation -%}
    {%- if node.inception_date or online_buttons(thing) -%}
      <p>
        {{- link(thing) -}}
        {%- if node.inception_date %}
          ({{ node.inception_date }})
        {% endif %}
        {{ online_buttons(thing) }}
      </p>
    {%- else -%}
      {{- link(thing) -}}
    {%- endif -%}
  {%- else -%}
    {{- thing -}}
  {%- endif -%}
  
  {% if node.images %}
    <div class="row-fluid">
      <div class="span8">
        {% if node.description %}
          {{ md2html(node.description) }}
        {% endif %}
      </div>
      <div class="span4">
        {% for image in node.images %}
          <img src="{{ image.url }}">
        {% endfor %}
      </div>
    </div>
  {% elif node.description %}
    {{ md2html(node.description) }}
  {% endif %}
{%- endmacro %}

{% macro list_all_of_type(collected_auspices) %}
  {% for auspices, things in iteritems_sorted_within(
      collected_auspices, [
          "Cat's Eye Technologies",
          "What is this I don't even",
          "None",
      ]
  ) %}
    {% if collected_auspices.keys() != [None] %}
      <h3>by {% if auspices == None %}Our Valued Partners{% else %}{{ auspices }}{% endif %}</h3>
    {% endif %}
    <ul>
      {%- for thing in keys_sorted_within(things, ordered_within) -%}
        {% if is_current(get_node(thing)) and online_buttons(thing) %}
          <li>{{ list_item(thing) }}</li>
        {% endif %}
      {%- endfor -%}
    </ul>
    <ul>
      {%- for thing in keys_sorted_within(things, ordered_within) -%}
        {% if is_current(get_node(thing)) and not online_buttons(thing) %}
          <li>{{ list_item(thing) }}</li>
        {% endif %}
      {%- endfor -%}
    </ul>
  {% endfor %}
{% endmacro %}

{% block title %}{{ plural(key) }} | Cat's Eye Technologies{% endblock title %}

{% block heading %}
  <h1>{{ plural(key) }}</h1>
{% endblock %}

{% set collected_auspices = group_by(related_items('type'), 'auspices') %}

{% block description_verbiage %}
  {%- if description -%}
    {{- md2html(description) -}}
  {%- elif collected_auspices.keys() == [None] %}
    <p>
      This is a list of {{ plural(key)|lower }} with entries in {{ link('Chrysoberyl') }}.
    </p>
  {%- endif -%}
{% endblock description_verbiage %}

{# note: some types will not use the 'index' block for this; they will instead
   put their index into the 'content' block, if they want to appear below
   any images and/or exploit maximum horizontal real estate. #}

{% block index %}
  {{ list_all_of_type(collected_auspices) }}
{% endblock index %}
